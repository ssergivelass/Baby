<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>BabyLog App</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0c10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<style>
:root{
  --bg:#0b0c10; --card:#14161c; --muted:#9aa3af; --text:#e5e7eb; --acc:#7c3aed; --good:#22c55e; --warn:#f59e0b; --blue:#3b82f6;
  --border:#23262e; --pad:14px; font-synthesis-weight: none;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f7f7fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --border:#e5e7eb; }
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%;}
body{ margin:0; font-family:-apple-system, BlinkMacSystemFont, Inter, Roboto, system-ui, Helvetica, Arial, sans-serif;
  background:var(--bg); color:var(--text); }
header{ position:sticky; top:0; z-index:10; background:rgba(11,12,16,0.85); backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border); }
@media (prefers-color-scheme: light){
  header{ background:rgba(255,255,255,0.85); }
}
h1{font-size:18px; margin:0; padding:12px 16px; text-align:center; letter-spacing:.2px;}
.container{padding:var(--pad); padding-bottom:96px;}
.card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:var(--pad); margin-bottom:12px;}
label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
input,select,textarea{
  width:100%; background:transparent; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px; font-size:16px;
}
input[type="datetime-local"]{padding:10px 12px;}
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
.btn{ width:100%; border:none; border-radius:12px; padding:14px; font-size:16px; color:white; }
.btn.pecho{background:var(--good);} .btn.panal{background:var(--warn);} .btn.sueno{background:var(--blue);} .btn.secondary{background:#1f2937;} .btn.danger{background:#ef4444;}
.small{font-size:12px; color:var(--muted);} .muted{color:var(--muted);}
.list{list-style:none; padding:0; margin:0;} .item{display:flex; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px solid var(--border);}
.kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:10px;} .kpi{background:transparent; border:1px dashed var(--border); border-radius:12px; padding:12px;}
.kpi h3{margin:0 0 8px 0; font-size:13px; color:var(--muted); font-weight:600;} .kpi .val{font-size:22px;}
.badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1f2937; color:#cbd5e1; margin-left:6px;}
@media (prefers-color-scheme: light){ .badge{ background:#eef2ff; color:#374151;} }
canvas{width:100%; height:180px; background:transparent; border:1px solid var(--border); border-radius:12px;}
/* Bottom nav */
.navbar{ position:fixed; bottom:0; left:0; right:0; height:72px; background:rgba(11,12,16,0.85); backdrop-filter: blur(10px);
  border-top:1px solid var(--border); display:grid; grid-template-columns:repeat(4,1fr); }
@media (prefers-color-scheme: light){ .navbar{ background:rgba(255,255,255,0.85);} }
.navbtn{ appearance:none; border:none; background:transparent; color:var(--muted); font-size:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; }
.navbtn.active{ color:var(--acc); }
.icon{font-size:22px;}
/* Quick actions */
.quick{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
.quick .btn{padding:16px; border-radius:14px;}
/* Sections */
section{display:none;}
section.active{display:block;}
hr{border:none; border-top:1px solid var(--border); margin:12px 0;}
</style>
</head>
<body>
<header><h1>üçº BabyLog</h1></header>
<main class="container">
  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">
      <h2 style="margin:0 0 10px 0;">Resumen de hoy</h2>
      <div id="homeSummary" class="small muted">Sin datos a√∫n.</div>
      <hr>
      <div class="kpis" id="homeKPIs"></div>
    </div>
    <div class="card">
      <h2 style="margin:0 0 10px 0;">Acciones r√°pidas</h2>
      <div class="quick">
        <button class="btn pecho" id="qaToma">+ Toma</button>
        <button class="btn panal" id="qaPanal">+ Pa√±al</button>
        <button class="btn sueno" id="qaSueno">+ Sue√±o</button>
      </div>
    </div>
    <div class="card">
      <h2 style="margin:0 0 10px 0;">Peso (√∫ltimos 30 d√≠as)</h2>
      <canvas id="chartPeso"></canvas>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="expPesoCSV">Exportar peso CSV</button>
        <button class="btn secondary" id="addPeso">A√±adir peso</button>
      </div>
    </div>
  </section>

  <!-- REGISTRAR -->
  <section id="registrar">
    <div class="card">
      <h2>Nueva entrada</h2>
      <div class="row">
        <select id="tipo">
          <option value="toma">Toma</option>
          <option value="panal">Pa√±al</option>
          <option value="sueno">Sue√±o</option>
          <option value="medicion">Medici√≥n</option>
          <option value="peso">Peso</option>
        </select>
        <input id="fecha" type="datetime-local">
      </div>
      <div id="campos"></div>
      <button class="btn" id="guardar" style="background:var(--acc);">Guardar</button>
      <p class="small">Local y offline. Exporta en Ajustes.</p>
    </div>
    <div class="card">
      <h2>Historial</h2>
      <div class="row">
        <input type="date" id="fDesde">
        <input type="date" id="fHasta">
      </div>
      <div class="row">
        <select id="fTipo">
          <option value="todos">Todos</option>
          <option value="toma">Toma</option>
          <option value="panal">Pa√±al</option>
          <option value="sueno">Sue√±o</option>
          <option value="medicion">Medici√≥n</option>
          <option value="peso">Peso</option>
        </select>
        <button class="btn secondary" id="aplicarFiltros">Aplicar filtros</button>
      </div>
      <ul class="list" id="lista"></ul>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard">
    <div class="card">
      <h2>Hoy</h2>
      <div class="kpis" id="kpisHoy"></div>
      <canvas id="chartHoy"></canvas>
    </div>
    <div class="card">
      <h2>√öltimos 7 d√≠as</h2>
      <div class="kpis" id="kpisSemana"></div>
      <canvas id="chartSemana"></canvas>
    </div>
    <div class="card">
      <h2>√öltimos 30 d√≠as</h2>
      <div class="kpis" id="kpisMes"></div>
      <canvas id="chartMes"></canvas>
    </div>
    <div class="card">
      <h2>Evoluci√≥n del peso</h2>
      <canvas id="chartPesoDash"></canvas>
      <p class="small muted" id="pesoHelp">Configura la l√≠nea de media esperada en Ajustes.</p>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="ajustes">
    <div class="card">
      <h2>Copias</h2>
      <button class="btn secondary" id="exportarJSON">Exportar JSON</button>
      <button class="btn secondary" id="importarJSON">Importar JSON</button>
      <input class="hidden" type="file" id="fileJSON" accept="application/json">
    </div>
    <div class="card">
      <h2>L√≠nea de media esperada (peso)</h2>
      <label>Activar l√≠nea esperada
        <select id="expOn">
          <option value="off">Desactivada</option>
          <option value="on">Activada</option>
        </select>
      </label>
      <div class="row">
        <div>
          <label>Fecha inicio (nacimiento)</label>
          <input type="date" id="expStart">
        </div>
        <div>
          <label>Peso inicio (kg, 2 dec.)</label>
          <input type="number" step="0.01" min="0" id="expStartKg" placeholder="3.50">
        </div>
      </div>
      <label>Ganancia semanal (kg/sem ‚Äî ej. 0.18)</label>
      <input type="number" step="0.01" min="0" id="expGain" placeholder="0.18">
      <p class="small muted">*Esta l√≠nea es orientativa y configurable por ti. No sustituye a controles pedi√°tricos.</p>
      <button class="btn secondary" id="saveExp">Guardar ajustes</button>
    </div>
    <div class="card">
      <h2>Preferencias</h2>
      <label>Modo oscuro autom√°tico (20:00‚Äì07:00)
        <select id="autoDark">
          <option value="on">Activado</option>
          <option value="off">Desactivado</option>
        </select>
      </label>
      <button class="btn danger" id="borrarTodo">Borrar TODOS los datos</button>
    </div>
  </section>
</main>

<!-- Bottom Nav -->
<nav class="navbar">
  <button class="navbtn active" data-tab="home"><div class="icon">üè†</div>Inicio</button>
  <button class="navbtn" data-tab="registrar"><div class="icon">‚ûï</div>Registrar</button>
  <button class="navbtn" data-tab="dashboard"><div class="icon">üìä</div>Dashboard</button>
  <button class="navbtn" data-tab="ajustes"><div class="icon">‚öôÔ∏è</div>Ajustes</button>
</nav>

<script>
const KEY='babylog.v3';
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{"items":[],"prefs":{}}'); }catch(e){ return {"items":[],"prefs":{}}; } }
function save(state){ localStorage.setItem(KEY, JSON.stringify(state)); }

const state = load();
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function pad(n){ return n.toString().padStart(2,'0'); }
function fmtDate(d){
  const dt=new Date(d); const y=dt.getFullYear(), m=pad(dt.getMonth()+1), day=pad(dt.getDate());
  const hh=pad(dt.getHours()), mm=pad(dt.getMinutes()); return `${y}-${m}-${day} ${hh}:${mm}`;
}
function toLocalInput(dt){ if(!dt) dt=new Date(); const off=dt.getTimezoneOffset(); const t=new Date(dt.getTime()-off*60000); return t.toISOString().slice(0,16); }
function fromLocalInput(val){ const d=new Date(val); const off = d.getTimezoneOffset(); return new Date(d.getTime()+off*60000).toISOString(); }
function durationMin(a,b){ return Math.max(0, Math.round((new Date(b)-new Date(a))/60000)); }

/* Auto dark (20-07) by toggling data-theme-dark attr */
function applyAutoDark(){
  const on = (state.prefs?.autoDark ?? 'on') === 'on';
  if(!on) return;
  const now = new Date(); const h = now.getHours(); const dark = (h >= 20 || h < 7);
  document.documentElement.setAttribute('data-dark', dark ? '1' : '0');
}
applyAutoDark(); setInterval(applyAutoDark, 60*1000);

/* Bottom nav */
$$('.navbtn').forEach(b=> b.onclick=()=>{
  $$('.navbtn').forEach(x=>x.classList.toggle('active', x===b));
  const tab=b.dataset.tab; $$('main > section').forEach(s=> s.classList.toggle('active', s.id===tab));
  if(tab==='dashboard'){ renderDashboard(); }
  if(tab==='home'){ renderHome(); }
});

/* Quick actions */
$('#qaToma').onclick=()=>{ switchTo('registrar'); $('#tipo').value='toma'; renderCampos('toma'); };
$('#qaPanal').onclick=()=>{ switchTo('registrar'); $('#tipo').value='panal'; renderCampos('panal'); };
$('#qaSueno').onclick=()=>{ switchTo('registrar'); $('#tipo').value='sueno'; renderCampos('sueno'); };
$('#addPeso').onclick=()=>{ switchTo('registrar'); $('#tipo').value='peso'; renderCampos('peso'); };

function switchTo(id){
  $$('.navbtn').forEach(x=> x.classList.toggle('active', x.dataset.tab===id));
  $$('main > section').forEach(s=> s.classList.toggle('active', s.id===id));
}

/* Forms */
$('#fecha').value = toLocalInput(new Date());
$('#tipo').addEventListener('change', e=> renderCampos(e.target.value));
function renderCampos(tipo){
  const c=$('#campos'); c.innerHTML='';
  if(tipo==='toma'){
    c.innerHTML=`
      <div class="row">
        <select id="tomaTipo"><option value="pecho">Pecho</option><option value="biberon">Biber√≥n</option></select>
        <select id="pechoLado"><option value="izquierdo">Izquierdo</option><option value="derecho">Derecho</option><option value="ambos">Ambos</option></select>
      </div>
      <div class="row">
        <input id="duracion" type="number" min="0" inputmode="numeric" placeholder="Duraci√≥n (min)">
        <input id="cantidad" type="number" min="0" inputmode="numeric" placeholder="Cantidad (ml si biber√≥n)">
      </div>
      <textarea id="notas" rows="2" placeholder="Notas (opcional)"></textarea>`;
  } else if(tipo==='panal'){
    c.innerHTML=`
      <div class="row">
        <select id="panalTipo"><option value="caca">Caca</option><option value="pis">Pis</option><option value="mixto">Mixto</option></select>
        <select id="panalCantidad"><option value="poco">Poco</option><option value="normal">Normal</option><option value="mucho">Mucho</option></select>
      </div>
      <textarea id="notas" rows="2" placeholder="Color/consistencia/irritaci√≥n (opcional)"></textarea>`;
  } else if(tipo==='sueno'){
    c.innerHTML=`
      <div class="row"><input id="inicio" type="datetime-local"><input id="fin" type="datetime-local"></div>
      <div class="row"><input id="despertares" type="number" min="0" inputmode="numeric" placeholder="Despertares">
        <select id="calidad"><option value="ok">Calidad: OK</option><option value="inquieto">Inquieto</option><option value="malo">Malo</option></select></div>
      <textarea id="notas" rows="2" placeholder="Notas (opcional)"></textarea>`;
    $('#inicio').value = toLocalInput(new Date()); $('#fin').value = toLocalInput(new Date());
  } else if(tipo==='medicion'){
    c.innerHTML=`
      <div class="row"><input id="temp" type="number" min="30" max="45" step="0.1" inputmode="decimal" placeholder="Temperatura (¬∞C)">
      <input id="extra" type="text" placeholder="Nota r√°pida"></div>`;
  } else if(tipo==='peso'){
    c.innerHTML=`
      <div class="row"><input id="pesoKg" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Peso (kg, 2 dec.)"></div>
      <p class="small muted">Ej. 3.995‚Üí se muestra 4.00 kg (dos decimales). Puedes escribir con coma o punto.</p>`;
  }
}
renderCampos($('#tipo').value);

/* Save */
$('#guardar').onclick=()=>{
  const tipo = $('#tipo').value;
  const fechaISO = fromLocalInput($('#fecha').value);
  const base = { id: crypto.randomUUID(), tipo, fecha: fechaISO };
  const items = state.items;
  if(tipo==='toma'){
    items.push({ ...base, tomaTipo: $('#tomaTipo').value, pechoLado: $('#pechoLado').value,
      duracion:+($('#duracion').value||0), cantidad:+($('#cantidad').value||0), notas:($('#notas').value||'').trim() });
  }else if(tipo==='panal'){
    items.push({ ...base, panalTipo: $('#panalTipo').value, panalCantidad: $('#panalCantidad').value, notas:($('#notas').value||'').trim() });
  }else if(tipo==='sueno'){
    items.push({ ...base, inicio: fromLocalInput($('#inicio').value), fin: fromLocalInput($('#fin').value),
      despertares:+($('#despertares').value||0), calidad:$('#calidad').value, notas:($('#notas').value||'').trim() });
  }else if(tipo==='medicion'){
    items.push({ ...base, temp: $('#temp').value? +$('#temp').value : null, extra: ($('#extra').value||'').trim() });
  }else if(tipo==='peso'){
    let v = ($('#pesoKg').value||'').replace(',','.');
    if(!v || isNaN(parseFloat(v))) { alert('Introduce un peso v√°lido (kg)'); return; }
    const kg = parseFloat(v);
    items.push({ ...base, pesoKg: kg });
  }
  save(state);
  toast('Guardado ‚úÖ');
  $('#fecha').value = toLocalInput(new Date()); renderCampos(tipo); renderHome();
};

/* Historial */
$('#aplicarFiltros').onclick=renderHistorial;
function renderHistorial(){
  const lista = $('#lista'); lista.innerHTML='';
  const tipo = $('#fTipo').value;
  const dDesde = $('#fDesde').value ? new Date($('#fDesde').value+'T00:00:00') : null;
  const dHasta = $('#fHasta').value ? new Date($('#fHasta').value+'T23:59:59') : null;
  const filtered = state.items.filter(it=>{
    if(tipo!=='todos' && it.tipo!==tipo) return false;
    const t = new Date(it.fecha);
    if(dDesde && t<dDesde) return false;
    if(dHasta && t>dHasta) return false;
    return true;
  }).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  if(filtered.length===0){ lista.innerHTML='<p class="small muted">Sin datos.</p>'; return; }
  for(const it of filtered){
    const li=document.createElement('li'); li.className='item';
    const left=document.createElement('div'); const right=document.createElement('div');
    right.innerHTML=`<button class="btn secondary" data-del="${it.id}" style="padding:8px 10px;">Eliminar</button>`;
    left.innerHTML = renderItem(it); li.appendChild(left); li.appendChild(right); lista.appendChild(li);
  }
  $$('#lista [data-del]').forEach(btn=> btn.onclick=()=>{
    const id = btn.dataset.del;
    if(confirm('¬øEliminar esta entrada?')){
      state.items = state.items.filter(x=>x.id!==id); save(state); renderHistorial(); renderHome(); renderDashboard();
    }
  });
}
function renderItem(it){
  const fecha = fmtDate(it.fecha);
  if(it.tipo==='toma'){
    const tag = it.tomaTipo==='pecho' ? `Pecho <span class="badge">${it.pechoLado}</span>` : `Biber√≥n <span class="badge">${it.cantidad||0} ml</span>`;
    return `<div><strong>üçº Toma</strong> ‚Äî ${tag} ‚Äî ${it.duracion||0} min<br><span class="small muted">${fecha}${it.notas? ' ¬∑ '+escapeHtml(it.notas):''}</span></div>`;
  }else if(it.tipo==='panal'){
    return `<div><strong>üß∑ Pa√±al</strong> ‚Äî ${it.panalTipo} ¬∑ ${it.panalCantidad}<br><span class="small muted">${fecha}${it.notas? ' ¬∑ '+escapeHtml(it.notas):''}</span></div>`;
  }else if(it.tipo==='sueno'){
    const mins = durationMin(it.inicio,it.fin);
    return `<div><strong>üåô Sue√±o</strong> ‚Äî ${mins} min ¬∑ despertares: ${it.despertares}<br><span class="small muted">${fmtDate(it.inicio)} ‚Üí ${fmtDate(it.fin)}${it.notas? ' ¬∑ '+escapeHtml(it.notas):''}</span></div>`;
  }else if(it.tipo==='peso'){
    return `<div><strong>‚öñÔ∏è Peso</strong> ‚Äî ${fmtKg(it.pesoKg)}<br><span class="small muted">${fecha}</span></div>`;
  }else{
    const bits=[]; if(it.temp!=null) bits.push(`Temp: ${it.temp} ¬∞C`);
    if(it.extra) bits.push(escapeHtml(it.extra));
    return `<div><strong>üìè Medici√≥n</strong> ‚Äî ${bits.join(' ¬∑ ')||'‚Äî'}<br><span class="small muted">${fecha}</span></div>`;
  }
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
function fmtKg(v){ return (Math.round(v*100)/100).toFixed(2).replace('.',',') + ' kg'; }

/* HOME */
function renderHome(){
  const today = new Date(); today.setHours(0,0,0,0);
  const dayItems = state.items.filter(it=> new Date(it.fecha) >= today);
  const last = (t)=> dayItems.filter(x=>x.tipo===t).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
  const sum = (f)=> dayItems.reduce((acc,it)=> acc + (f(it)||0), 0);
  const lastToma = last('toma');
  const lastPanal = last('panal');
  const lastPeso = state.items.filter(x=>x.tipo==='peso').sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
  const suenoMin = dayItems.filter(x=>x.tipo==='sueno').reduce((a,x)=>a+durationMin(x.inicio,x.fin),0);
  const lines = [];
  lines.push(lastToma ? `√öltima toma: ${fmtDate(lastToma.fecha)} ‚Äî ${lastToma.tomaTipo}${lastToma.tomaTipo==='pecho'? ' ('+lastToma.pechoLado+')' : ' ('+(lastToma.cantidad||0)+' ml)'}` : 'Sin tomas registradas hoy');
  lines.push(lastPanal ? `√öltimo pa√±al: ${fmtDate(lastPanal.fecha)} ‚Äî ${lastPanal.panalTipo} ¬∑ ${lastPanal.panalCantidad}` : 'Sin pa√±ales registrados hoy');
  lines.push(`Sue√±o acumulado hoy: ${(suenoMin/60).toFixed(1)} h`);
  lines.push(lastPeso ? `Peso m√°s reciente: ${fmtKg(lastPeso.pesoKg)}` : 'A√∫n sin peso registrado');
  $('#homeSummary').innerHTML = lines.map(l=>`<div>${l}</div>`).join('');

  // KPIs hoy
  const k=calcKPIs(dayItems);
  $('#homeKPIs').innerHTML = `
    <div class="kpi"><h3>Tomas</h3><div class="val">${k.tomas}</div></div>
    <div class="kpi"><h3>Pa√±ales</h3><div class="val">${k.panales}</div></div>
    <div class="kpi"><h3>Sue√±o (h)</h3><div class="val">${(k.minSueno/60).toFixed(1)}</div></div>
    <div class="kpi"><h3>Despertares</h3><div class="val">${k.despertares}</div></div>
  `;

  drawWeight($('#chartPeso'), 30);
}
renderHome();

/* DASHBOARD */
function renderDashboard(){
  const now = new Date();
  const startHoy = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const startSemana = new Date(now.getTime()-6*86400000); startSemana.setHours(0,0,0,0);
  const startMes = new Date(now.getTime()-29*86400000); startMes.setHours(0,0,0,0);
  const inRange = (it, start)=> new Date(it.fecha)>=start;
  const hoy = state.items.filter(it=> inRange(it,startHoy));
  const semana = state.items.filter(it=> inRange(it,startSemana));
  const mes = state.items.filter(it=> inRange(it,startMes));
  renderKPIs(hoy, $('#kpisHoy'));
  renderKPIs(semana, $('#kpisSemana'));
  renderKPIs(mes, $('#kpisMes'));
  drawBars($('#chartHoy'), groupByDay(hoy, startHoy, 1));
  drawBars($('#chartSemana'), groupByDay(semana, startSemana, 7));
  drawBars($('#chartMes'), groupByDay(mes, startMes, 30));
  drawWeight($('#chartPesoDash'), 90);
}
function renderKPIs(items, el){
  const k = calcKPIs(items);
  el.innerHTML = `
    <div class="kpi"><h3>Tomas</h3><div class="val">${k.tomas}</div></div>
    <div class="kpi"><h3>Min. pecho</h3><div class="val">${k.minPecho}</div></div>
    <div class="kpi"><h3>ml biber√≥n</h3><div class="val">${k.mlBiberon}</div></div>
    <div class="kpi"><h3>Pa√±ales</h3><div class="val">${k.panales}</div></div>
    <div class="kpi"><h3>Sue√±o (h)</h3><div class="val">${(k.minSueno/60).toFixed(1)}</div></div>
    <div class="kpi"><h3>Despertares</h3><div class="val">${k.despertares}</div></div>`;
}
function calcKPIs(items){
  let tomas=0, minPecho=0, mlBiberon=0, panales=0, minSueno=0, despertares=0;
  for(const it of items){
    if(it.tipo==='toma'){ tomas++; if(it.tomaTipo==='pecho') minPecho += +it.duracion||0; if(it.tomaTipo==='biberon') mlBiberon += +it.cantidad||0; }
    else if(it.tipo==='panal'){ panales++; }
    else if(it.tipo==='sueno'){ minSueno += durationMin(it.inicio,it.fin); despertares += +it.despertares||0; }
  }
  return { tomas, minPecho, mlBiberon, panales, minSueno, despertares };
}
function groupByDay(items, startDate, days){
  const fmt = d=>`${pad(d.getDate())}/${pad(d.getMonth()+1)}`;
  const labels=[], tomas=[], panales=[], suenoH=[];
  for(let i=0;i<days;i++){
    const d=new Date(startDate.getTime()+i*86400000);
    labels.push(fmt(d));
    const sameDay = items.filter(x=>{
      const t=new Date(x.fecha);
      return t.getFullYear()===d.getFullYear() && t.getMonth()===d.getMonth() && t.getDate()===d.getDate();
    });
    const k = calcKPIs(sameDay);
    tomas.push(k.tomas); panales.push(k.panales); suenoH.push(+((k.minSueno/60).toFixed(1)));
  }
  return {labels, series:[{name:'Tomas', data:tomas},{name:'Pa√±ales', data:panales},{name:'Sue√±o (h)', data:suenoH}]};
}

/* Drawing utilities */
function drawBars(canvas, data){
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth * devicePixelRatio;
  const h = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  const padding=20*devicePixelRatio;
  const labels = data.labels, series = data.series;
  let max=1; for(const s of series) for(const v of s.data) max=Math.max(max, v);
  const colors = ['#22c55e','#f59e0b','#3b82f6'];
  const barGroupWidth = (w - 2*padding) / labels.length;
  const barWidth = barGroupWidth / (series.length+0.5);
  ctx.lineWidth = 1*devicePixelRatio; ctx.font = `${10*devicePixelRatio}px -apple-system, Inter`; ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#23262e';
  const steps = 4;
  for(let i=0;i<=steps;i++){ const y = padding + (h-2*padding) * i/steps; ctx.beginPath(); ctx.moveTo(padding,y); ctx.lineTo(w-padding,y); ctx.stroke(); }
  labels.forEach((lab, i)=>{
    series.forEach((s, j)=>{
      const v = s.data[i];
      const x = padding + i*barGroupWidth + j*barWidth;
      const y = padding + (1 - v/max) * (h-2*padding);
      const bh = (h-2*padding) * (v/max);
      ctx.fillStyle = colors[j % colors.length];
      ctx.fillRect(x+2, y, barWidth-4, bh);
    });
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#9aa3af';
    ctx.fillText(lab, padding + i*barGroupWidth + (series.length*barWidth)/2, h - padding + 4*devicePixelRatio);
  });
}

/* Weight chart with optional expected mean line */
function drawWeight(canvas, days){
  const ctx=canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth * devicePixelRatio;
  const h = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  const padding=26*devicePixelRatio;

  const now=new Date(); const start=new Date(now.getTime()-(days-1)*86400000); start.setHours(0,0,0,0);
  const points = state.items.filter(x=> x.tipo==='peso' && new Date(x.fecha)>=start).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
  const labels=[], vals=[];
  for(let i=0;i<days;i++){
    const d=new Date(start.getTime()+i*86400000);
    labels.push(`${pad(d.getDate())}/${pad(d.getMonth()+1)}`);
    // take last weight of that day if exists
    const dayPts = points.filter(p=>{
      const t=new Date(p.fecha); return t.getFullYear()===d.getFullYear() && t.getMonth()===d.getMonth() && t.getDate()===d.getDate();
    });
    vals.push(dayPts.length? dayPts[dayPts.length-1].pesoKg : null);
  }
  // interpolate nulls for nicer line
  const numeric = vals.map(v=> v==null ? NaN : v);
  const filled = interpolateNa(numeric);

  // expected line (optional)
  let expLine = null;
  if((state.prefs?.expOn||'off')==='on' && state.prefs.expStart && state.prefs.expStartKg && state.prefs.expGain){
    const startDate = new Date(state.prefs.expStart+'T00:00:00');
    const w0 = parseFloat(state.prefs.expStartKg);
    const gain = parseFloat(state.prefs.expGain); // kg per week
    expLine = [];
    for(let i=0;i<days;i++){
      const d=new Date(start.getTime()+i*86400000);
      const weeks = (d - startDate) / (7*86400000);
      expLine.push( w0 + Math.max(0,weeks) * gain );
    }
  }

  const allVals = filled.filter(x=>!isNaN(x)).concat(expLine||[]);
  const minV = Math.min(...allVals, 0) || 0;
  const maxV = Math.max(...allVals, 1) || 1;
  const yMin = Math.floor(minV*10)/10;
  const yMax = Math.ceil(maxV*10)/10;

  // grid
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#23262e';
  const steps=4;
  for(let i=0;i<=steps;i++){
    const y = padding + (h-2*padding) * i/steps;
    ctx.beginPath(); ctx.moveTo(padding,y); ctx.lineTo(w-padding,y); ctx.stroke();
  }

  // axes labels (x sampled)
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#9aa3af';
  ctx.font = `${10*devicePixelRatio}px -apple-system, Inter`; ctx.textAlign='center'; ctx.textBaseline='top';
  const step = Math.ceil(labels.length/6);
  labels.forEach((lab,i)=>{ if(i%step===0){ const x = padding + i*( (w-2*padding)/(labels.length-1||1) ); ctx.fillText(lab, x, h - padding + 4*devicePixelRatio);} });

  // y helper
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let i=0;i<=steps;i++){
    const v = yMin + (yMax - yMin)*i/steps;
    const y = padding + (h-2*padding) * (i/steps);
    ctx.fillText(v.toFixed(1).replace('.',','), padding-6*devicePixelRatio, y);
  }

  // draw line function
  function line(values, color){
    ctx.lineWidth = 2*devicePixelRatio; ctx.strokeStyle = color;
    ctx.beginPath();
    values.forEach((v,i)=>{
      if(isNaN(v)) return;
      const x = padding + i*( (w-2*padding)/(values.length-1||1) );
      const y = padding + (1 - (v - yMin)/(yMax - yMin)) * (h-2*padding);
      if(i===0 || isNaN(values[i-1])) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  // actual weight
  line(filled, '#7c3aed');
  // expected
  if(expLine){ line(expLine, '#22c55e'); }
}

function interpolateNa(arr){
  const out=arr.slice();
  // forward fill and simple linear interpolation
  let lastIdx=null;
  for(let i=0;i<arr.length;i++){
    if(!isNaN(arr[i])){
      if(lastIdx===null && i>0){ for(let j=0;j<i;j++) out[j]=arr[i]; }
      if(lastIdx!==null){
        const a=arr[lastIdx], b=arr[i], dist=i-lastIdx;
        for(let j=1;j<dist;j++){ out[lastIdx+j] = a + (b-a)*(j/dist); }
      }
      lastIdx=i;
    }
  }
  if(lastIdx is None):
      pass
  return out.map(v=> isNaN(v)? out[lastIdx] : v);
}

/* Export peso CSV */
$('#expPesoCSV').onclick=()=>{
  const weights = state.items.filter(x=>x.tipo==='peso').sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
  const rows=[['fecha','peso_kg']].concat(weights.map(w=>[w.fecha, (Math.round(w.pesoKg*100)/100).toFixed(2)]));
  const csv = rows.map(r=> r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='babylog_peso.csv'; a.click();
};

/* Export/Import general */
$('#exportarJSON').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='babylog_backup.json'; a.click();
};
$('#importarJSON').onclick=()=> $('#fileJSON').click();
$('#fileJSON').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text(); const obj=JSON.parse(txt);
    if(!obj || !Array.isArray(obj.items)) throw new Error('Formato no v√°lido');
    if(!confirm('Esto reemplazar√° tus datos actuales. ¬øContinuar?')) return;
    state.items = obj.items; state.prefs = obj.prefs||{}; save(state);
    toast('Datos importados ‚úÖ'); renderHome(); renderDashboard();
  }catch(err){ alert('Error al importar: '+err.message); }
  e.target.value='';
});

/* Ajustes medias esperadas + preferencias */
function loadPrefsUI(){
  $('#expOn').value = state.prefs?.expOn || 'off';
  $('#expStart').value = state.prefs?.expStart || '';
  $('#expStartKg').value = state.prefs?.expStartKg || '';
  $('#expGain').value = state.prefs?.expGain || '';
  $('#autoDark').value = state.prefs?.autoDark || 'on';
}
$('#saveExp').onclick=()=>{
  state.prefs = state.prefs||{};
  state.prefs.expOn = $('#expOn').value;
  state.prefs.expStart = $('#expStart').value;
  state.prefs.expStartKg = $('#expStartKg').value;
  state.prefs.expGain = $('#expGain').value;
  state.prefs.autoDark = $('#autoDark').value;
  save(state); toast('Preferencias guardadas'); renderHome(); renderDashboard();
};
loadPrefsUI();

/* Danger zone */
$('#borrarTodo').onclick=()=>{
  if(confirm('¬øSeguro que quieres borrar TODOS los datos?')){
    state.items=[]; save(state); renderHome(); renderDashboard(); renderHistorial(); toast('Base vac√≠a');
  }
};

/* Utils */
function toast(msg){
  const el=document.createElement('div'); el.textContent=msg;
  el.style.position='fixed'; el.style.bottom='90px'; el.style.left='50%'; el.style.transform='translateX(-50%)';
  el.style.background='rgba(0,0,0,0.8)'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.zIndex=20;
  document.body.appendChild(el); setTimeout(()=> el.remove(), 1500);
}

// Service Worker
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }); }
</script>
</body>
</html>
